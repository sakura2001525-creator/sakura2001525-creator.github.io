<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="barcode.css">
<title>バーコード読取り</title>
</head>
<body>
<h3>バーコード</h3>
<div id="scanner-container"></div>
<div id="barcode-result" style="font-size: 1rem;">
スキャン結果：
</div>
</body>
<script 
	src="https://code.jquery.com/jquery-3.6.1.min.js" 
	integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" 
	crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.js"></script>
<script>
const resultElement = document.getElementById("barcode-result");
let lastDetectedCodes = [];
const REQUIRED_MATCHES = 3;
Quagga.init({
	navigator.mediaDevices.getUserMedia(
    //マイクはオフ, カメラの設定   背面カメラを希望する 640×480を希望する
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then( //許可された場合
    function(stream){
      scanner-container.srcObject = stream;
      //0.5秒毎にスキャンする
      setTimeout(Scan,500,true);
    }
  ).catch( //許可されなかった場合
    
  );
    inputStream: {
        type: "LiveStream",
        constraints: {
            width: 1280,
            height: 720,
            facingMode: "environment",
        },
		target: document.querySelector("#scanner-container"),
	},
	locator: {
		patchSize: "medium",
		halfSample: false
	},
	decoder:{
		readers: [codabar_reader]
	},
	locate: true,
	numOfWorkers: navigator.hndwareConcurrency || 4,
	frequency: 5
}, function (err){
	if (err){
		console.error(err);
		resultElement.textContent = "エラー" + err;
		return;
	}
	Quagga.start();
});

Quagga.onDetected((data) => {
	const code = data.codeResult.code;
	if (!code) return;

	lastDetectedCodes.push(code);

	if (lastDetectedCodes.length >= 3) {
		const lastThree = lastDetectedCodes.slice(-3);
		const allSame = lastThree.every(c => c === lastThree[0]);
		if (allSame) {
			resultElement.textContent = 'スキャン結果：${code}';
			console.log("バーコード：", code);
			Quagga.stop();
		}
		
	});
	
}
</script>
</html>
